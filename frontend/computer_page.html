<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>פרטי מחשב</title>
    <link rel="stylesheet" href="./css/computers_list.css">
    <style>
    body { background:#071028; color:#e2e8f0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding:18px; }
    .container { max-width:1100px; margin:0 auto; }

    /* כותרת ראשית רשמית ומסודרת */
    .header-frame {
        position: sticky; top: 18px;
        background: linear-gradient(180deg, rgba(7,16,40,0.98), rgba(6,12,28,0.98));
        border: 1px solid rgba(35,53,84,0.9);
        border-radius: 12px;
        padding: 14px 18px;
        z-index: 200;
        box-shadow: 0 8px 30px rgba(0,0,0,0.5);
        margin-bottom: 16px;
    }
    .header-main {
        display:flex;
        gap:16px;
        align-items:center;
        justify-content:space-between;
        flex-wrap:wrap;
    }
    .header-left {
        display:flex;
        flex-direction:column;
        gap:8px;
        align-items:flex-end; /* RTL: name on the right */
    }
    .computer-name-large {
        font-size:1.9rem;                       /* גדל */
        font-family: "Georgia", "Times New Roman", serif; /* גופן שונה ורשמי יותר */
        color:#e6fff8;
        font-weight:800;
        letter-spacing:0.6px;
        line-height:1;
        text-transform:none;
    }
    .computer-sub {
        font-size:0.95rem;
        color:#9adbd1;
        opacity:0.95;
        display:flex;
        gap:8px;
        align-items:center;
    }

    .header-right {
        display:flex;
        gap:10px;
        align-items:center;
    }
    .summary-cards {
        display:flex;
        gap:10px;
        align-items:center;
    }
    .summary-card {
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        min-width:120px;
        padding:8px 12px;
        border-radius:10px;
        background: rgba(11,22,38,0.6);
        border: 1px solid rgba(100,255,218,0.06);
        box-shadow: 0 6px 16px rgba(0,0,0,0.35);
        text-align:center;
    }
    .summary-title {
        font-size:0.82rem;
        color:#bfeee5;
        opacity:0.9;
        margin-bottom:4px;
    }
    .summary-value {
        font-size:1.05rem;
        color:#e6fff8;
        font-weight:800;
    }
    .summary-value.positive { color:#9adbd1; }
    .summary-value.warning { color:#ffb4a4; }

    /* תיבת חיפוש - עדכון: מסגרת וטקסט בצבע הירוק של כמות הלוגים (#9adbd1) */
    .search-small {
        padding:7px 10px;
        border-radius:8px;
        border:1px solid rgba(154,219,209,0.12);
        background: rgba(7,22,36,0.85);
        color:#9adbd1;
        min-width:220px;
        outline:none;
        direction:rtl;
    }
    .search-small::placeholder { color: rgba(154,219,209,0.6); } /* placeholder בגוון ירוק שקוף */
    .search-small:focus {
        border-color: #64ffda;
        box-shadow: 0 0 10px rgba(100,255,218,0.08);
    }

    /* כרטיס קובץ */
    .file-card { background:#0f1b30; border:1px solid #233554; border-radius:12px; padding:14px; margin-bottom:18px; box-shadow:0 6px 18px rgba(0,0,0,0.35); overflow: hidden; }

    /* שורת כותרת הלוג: שם גדול מימין, פרטי מיקום/חשוד משמאל */
    .file-title-row { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }

    /* שונה: כותרת קצת קטנה יותר אבל בולטת וצבע שונה (ירוק בהיר) */
    .file-title-main { font-size:1.4rem; color:#9adbd1; font-weight:800; text-align:right; line-height:1.05; text-shadow: 0 1px 0 rgba(0,0,0,0.4); }

    .file-title-meta { display:flex; align-items:center; gap:8px; font-size:0.95rem; color:#e2e8f0; direction:ltr; white-space:nowrap; }

    .meta-badge { background:#233554; color:#e2e8f0; padding:6px 10px; border-radius:8px; border:1px solid rgba(100,255,218,0.06); font-weight:600; }
    .suspicious-inline { background:#ff4d4f; color:#fff; border-color:#ff4d4f; box-shadow: 0 2px 8px rgba(255,77,79,0.12); }

    .file-meta { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
    .meta-item { background:#0b1626; border:1px solid #233554; padding:10px 14px; border-radius:8px; font-weight:600; min-width:120px; text-align:center; box-shadow: inset 0 -6px 12px rgba(0,0,0,0.15); }
    .meta-item.suspicious { color:#ff4d4f; border-color:#ff4d4f; background:#2a1a1a; font-weight:700; }

    .suspicious-words { color:#ff4d4f; font-weight:700; margin-bottom:10px; }

    .window-card { background:#071f36; border:1px solid #233554; border-radius:10px; padding:12px; margin-bottom:10px; }
    .window-title { font-size:1rem; color:#64ffda; font-weight:700; margin-bottom:6px; text-align:right; }
    .window-content { font-family: "Share Tech Mono", monospace; white-space:pre-wrap; color:#e6eef6; font-size:1rem; background:#072133; padding:10px; border-radius:8px; border:1px solid rgba(35,53,84,0.6); }

    .no-files { color:#cbd5e1; padding:18px; text-align:center; }
    .content-area { padding-top: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-frame" role="region" aria-label="כותרת מחשב">
            <div class="header-main">
                <div class="header-left">
                    <div class="computer-name-large" id="computer-name">מחשב:</div>
                    <div class="computer-sub">
                        <div id="computer-desc">פרטי מערכת מסודרים</div>
                        <div style="width:6px;"></div>
                        <div id="files-count" class="files-count">סה"כ קבצים: 0</div>
                    </div>
                </div>

                <div class="header-right">
                    <div class="summary-cards" aria-hidden="false">
                        <div class="summary-card" title="סך כל הקבצים">
                            <div class="summary-title">קבצים</div>
                            <div id="summary-files" class="summary-value positive">0</div>
                        </div>
                        <div class="summary-card" title="קבצים עם מילות חשוד">
                            <div class="summary-title">חשודים</div>
                            <div id="summary-suspicious" class="summary-value warning">0</div>
                        </div>
                        <div class="summary-card" title="מיקומים ייחודיים">
                            <div class="summary-title">מיקומים</div>
                            <div id="summary-locations" class="summary-value">0</div>
                        </div>
                    </div>

                    <div class="search-inline">
                        <input id="search-box" class="search-small" placeholder="חפש (שם/מיקום/תוכן)..." />
                    </div>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div id="computer-details"></div>
        </div>
    </div>

<script>
const params = new URLSearchParams(window.location.search);
const name = params.get('name') || '';
document.getElementById('computer-name').textContent = `מחשב: ${name}`;

let allFilesData = {}

/* parsePythonDict - תיקון זהיר להמרת המחרוזת dict של פייתון לאובייקט JS */
function parsePythonDict(str) {
    if (!str || typeof str !== 'string') return {};
    try {
        // החלפת True/False/None
        let s = str.replace(/\bTrue\b/g,'true').replace(/\bFalse\b/g,'false').replace(/\bNone\b/g,'null');
        // המרה של מפתחות עם single quotes ל-JSON: 'key': -> "key":
        s = s.replace(/'([^']*?)'\s*:/g, function(_, k){ return JSON.stringify(k) + ':'; });
        // המרה של ערכים ב-single quotes: : 'val' -> : "val"
        s = s.replace(/:\s*'([^']*?)'/g, function(_, v){ return ': ' + JSON.stringify(v); });
        return JSON.parse(s);
    } catch (e) {
        try {
            // fallback מאוד זהיר
            return (new Function('return ' + str))();
        } catch (e2) {
            return {};
        }
    }
}

function escapeHtml(s){
    if (s === null || s === undefined) return '';
    return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
}

function renderFiles(filesData, searchTerm = '') {
    const container = document.getElementById('computer-details');
    let filesHtml = '';
    let count = 0;
    const entries = Object.entries(filesData || {}).sort((a,b)=> b[0].localeCompare(a[0])); // newest first by filename

    const q = (searchTerm||'').trim().toLowerCase();

    entries.forEach(([filename, fileObj]) => {
        let raw = fileObj.text_content !== undefined ? fileObj.text_content : fileObj.data;
        let parsed = {};
        if (typeof raw === 'string') parsed = parsePythonDict(raw);
        else if (typeof raw === 'object') parsed = raw || {};

        // search
        const matchesSearch = !q || (
            filename.toLowerCase().includes(q) ||
            (parsed.city && parsed.city.toLowerCase().includes(q)) ||
            (parsed.country && parsed.country.toLowerCase().includes(q)) ||
            (Array.isArray(parsed['suspicious words']) && parsed['suspicious words'].join(',').toLowerCase().includes(q)) ||
            (parsed.data && Object.values(parsed.data).some(v => typeof v==='string' && v.toLowerCase().includes(q)))
        );
        if (!matchesSearch) return;

        count++;
        const city = parsed.city ? escapeHtml(parsed.city) : '';
        const country = parsed.country ? escapeHtml(parsed.country) : '';
        const loc = (city && country) ? `${city}, ${country}` : (city || country);
        const suspiciousBadge = parsed.label === 'suspicious' ? `<span class="meta-badge suspicious-inline">חשוד</span>` : '';

        filesHtml += `<div class="file-card">`;

        // title row: big filename at right, location + suspicious at left
        filesHtml += `
            <div class="file-title-row">
                <div class="file-title-main">${escapeHtml(filename.replace(/\.txt|\.json$/i,''))}</div>
                <div class="file-title-meta">
                    ${ loc ? `<span class="meta-badge">${loc}</span>` : '' }
                    ${ suspiciousBadge }
                </div>
            </div>
        `;

        // (הסרתי הצגת זמן כאן לפי בקשתך)

        const suspiciousWords = Array.isArray(parsed['suspicious words']) ? parsed['suspicious words'].join(', ') : '';
        if (suspiciousWords) filesHtml += `<div class="suspicious-words">מילים חשודות: ${escapeHtml(suspiciousWords)}</div>`;

        // show each window as a card
        if (parsed.data && typeof parsed.data === 'object' && Object.keys(parsed.data).length) {
            Object.entries(parsed.data).forEach(([win, val]) => {
                const content = (val === null || val === undefined) ? '' : String(val);
                const normalized = content.replace(/\\n/g, '\n');
                filesHtml += `
                    <div class="window-card">
                        <div class="window-title">${escapeHtml(win)}</div>
                        <div class="window-content">${escapeHtml(normalized)}</div>
                    </div>
                `;
            });
        } else {
            filesHtml += `<div class="window-card"><div class="window-content">אין נתוני חלונות</div></div>`;
        }

        filesHtml += `</div>`; // file-card
    });

    if (!count) container.innerHTML = `<div class="no-files">לא נמצאו קבצים</div>`;
    else container.innerHTML = filesHtml;

    document.getElementById('files-count').textContent = `סה"כ קבצים: ${count}`;
}

/* חדש: חישוב וסיכום פרטי הכותרת */
function computeSummaries(filesData){
    const summaries = { total:0, suspicious:0, locations:new Set(), lastUpdate: null };
    Object.entries(filesData || {}).forEach(([fname, fobj])=>{
        summaries.total++;
        let raw = fobj.text_content !== undefined ? fobj.text_content : fobj.data;
        let parsed = {};
        if (typeof raw === 'string') parsed = parsePythonDict(raw);
        else if (typeof raw === 'object') parsed = raw || {};

        // suspicious detection
        const rawSusp = parsed['suspicious words'] ?? parsed['suspicious_words'] ?? parsed.suspiciousWords ?? parsed.suspicious;
        if ((Array.isArray(rawSusp) && rawSusp.length) || (typeof rawSusp === 'string' && rawSusp.trim()) || parsed.label === 'suspicious') summaries.suspicious++;

        // locations
        const city = parsed.city?.toString().trim();
        const country = parsed.country?.toString().trim();
        if(city || country) summaries.locations.add(`${city||''}${city && country ? ', ' : ''}${country||''}`);

        // possible timestamp candidate (try common fields)
        const cand = parsed.time ?? parsed.timestamp ?? parsed.date ?? parsed['time'] ?? parsed['timestamp'];
        if(cand){
            const t = new Date(String(cand));
            if(!isNaN(t)) {
                if(!summaries.lastUpdate || t > summaries.lastUpdate) summaries.lastUpdate = t;
            } else {
                // if not ISO date - attempt parse numbers (fallback: ignore)
            }
        }
    });
    return summaries;
}

function updateHeaderSummaries(filesData){
    const s = computeSummaries(filesData || {});
    document.getElementById('summary-files').textContent = s.total;
    document.getElementById('summary-suspicious').textContent = s.suspicious;
    document.getElementById('summary-locations').textContent = s.locations.size;
    document.getElementById('files-count').textContent = `סה"כ קבצים: ${s.total}`;

    // optional: last update formatting
    const desc = document.getElementById('computer-desc');
    if(s.lastUpdate){
        const d = s.lastUpdate;
        const formatted = d.toLocaleString('he-IL', { dateStyle:'medium', timeStyle:'short' });
        desc.textContent = `עודכן לאחרונה: ${formatted}`;
    } else {
        desc.textContent = 'פרטי מערכת מסודרים';
    }
}

/* Fetch and init */
fetch(`http://127.0.0.1:5000/files?computer=${encodeURIComponent(name)}`)
.then(r => r.json())
.then(data => {
    allFilesData = data || {};
    renderFiles(allFilesData);
    updateHeaderSummaries(allFilesData); // עדכון הסיכומים בכותרת
})
.catch(err => {
    document.getElementById('computer-details').innerHTML = '<div class="no-files">שגיאה בטעינת הנתונים</div>';
    console.error(err);
});

/* search */
document.getElementById('search-box').addEventListener('input', (e)=>{
    renderFiles(allFilesData, e.target.value);
});
</script>
</body>
</html>